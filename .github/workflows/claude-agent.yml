name: Claude Agent

on:
  # Run every 5 minutes
  schedule:
    - cron: "*/5 * * * *"

  # Allow manual trigger
  workflow_dispatch:
    inputs:
      prompt_override:
        description: "Custom prompt for Claude (optional)"
        required: false
        type: string

permissions:
  contents: write
  pull-requests: write
  id-token: write

jobs:
  check-pending-tasks:
    runs-on: ubuntu-latest
    outputs:
      has_pending_tasks: ${{ steps.check.outputs.has_pending_tasks }}
    steps:
      - name: Check for pending tasks
        id: check
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
        run: |
          echo "Checking for pending tasks..."
          RESPONSE=$(curl -s \
            -H "apikey: $SUPABASE_SERVICE_KEY" \
            -H "Authorization: Bearer $SUPABASE_SERVICE_KEY" \
            "$SUPABASE_URL/rest/v1/agent_tasks?status=eq.pending&select=id&limit=1")

          echo "Response: $RESPONSE"

          # Check if response is a non-empty array
          if [ "$RESPONSE" != "[]" ] && [ -n "$RESPONSE" ]; then
            echo "Found pending tasks"
            echo "has_pending_tasks=true" >> $GITHUB_OUTPUT
          else
            echo "No pending tasks found"
            echo "has_pending_tasks=false" >> $GITHUB_OUTPUT
          fi

  work-on-tasks:
    runs-on: ubuntu-latest
    needs: check-pending-tasks
    if: needs.check-pending-tasks.outputs.has_pending_tasks == 'true'
    timeout-minutes: 30

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"

      - name: Build MCP server
        run: |
          cd mcp-servers/autoship-mcp
          npm install
          npm run build

      - name: Configure git
        run: |
          git config user.name "Claude Agent"
          git config user.email "claude-agent@users.noreply.github.com"
          git config url."https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/".insteadOf "https://github.com/"

      - name: Run Claude Agent
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          prompt: |
            ${{ inputs.prompt_override || 'You are an autonomous coding agent. Your job is to work on tasks from the task queue.

            IMPORTANT: Follow these steps in order:

            1. First, use `mcp__autoship-mcp__list_pending_tasks` to see available tasks
            2. Pick the highest priority task from the list
            3. Use `mcp__autoship-mcp__claim_task` to claim it (this prevents other agents from working on it)
            4. Read the task description carefully
            5. Create a new git branch for your work (e.g., `agent/add-logout-button`)
            6. Implement the changes requested in the task
            7. Commit your changes with a clear commit message
            8. Use `mcp__autoship-mcp__complete_task` to mark it complete, providing the branch name

            If you encounter an error or cannot complete the task:
            - Use `mcp__autoship-mcp__fail_task` to mark it as failed with an explanation

            If you need clarification from the user:
            - Use `mcp__autoship-mcp__ask_question` to ask a question (this will mark the task as needs_info)

            Work autonomously and efficiently. Make sure to test your changes if applicable.' }}
          claude_args: |
            --max-turns 50
            --mcp-config '{"mcpServers":{"autoship-mcp":{"command":"node","args":["./mcp-servers/autoship-mcp/dist/index.js"],"env":{"SUPABASE_URL":"${{ secrets.SUPABASE_URL }}","SUPABASE_SERVICE_KEY":"${{ secrets.SUPABASE_SERVICE_KEY }}"}}}}'
            --allowedTools "Bash,Read,Write,Edit,Glob,Grep,mcp__autoship-mcp__list_pending_tasks,mcp__autoship-mcp__get_task,mcp__autoship-mcp__claim_task,mcp__autoship-mcp__complete_task,mcp__autoship-mcp__fail_task,mcp__autoship-mcp__add_task,mcp__autoship-mcp__list_categories,mcp__autoship-mcp__create_category,mcp__autoship-mcp__assign_category,mcp__autoship-mcp__ask_question,mcp__autoship-mcp__get_unanswered_questions,mcp__autoship-mcp__check_answered_questions,mcp__autoship-mcp__resume_task"

      - name: Push branch if created
        run: |
          # Check if we're on a new branch (not main)
          CURRENT_BRANCH=$(git branch --show-current)
          if [ "$CURRENT_BRANCH" != "main" ] && [ -n "$CURRENT_BRANCH" ]; then
            echo "Pushing branch: $CURRENT_BRANCH"
            git push -u origin "$CURRENT_BRANCH"

            # Create PR using GitHub CLI
            echo "Creating PR for branch: $CURRENT_BRANCH"
            if gh pr list --head "$CURRENT_BRANCH" --json number --jq '.[0].number' | grep -q .; then
              echo "PR already exists for this branch"
            else
              gh pr create \
                --title "$(git log -1 --pretty=%s)" \
                --body "This PR was created by the Claude Agent.

          See the agent_tasks table in Supabase for task details." \
                --base main \
                --head "$CURRENT_BRANCH"
              echo "PR created successfully"
            fi
          else
            echo "No new branch to push"
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
